---
import DocLayout from '../layouts/DocLayout.astro';
import { getCollection } from 'astro:content';

const docs = await getCollection('docs');
const sortedDocs = docs.sort((a, b) => (a.data.order || 999) - (b.data.order || 999));
---

<DocLayout title="Documentation Search">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-4xl font-bold mb-8">Search Documentation</h1>

    <div class="mb-8">
      <input
        type="search"
        id="doc-search"
        placeholder="Search docs..."
        class="w-full px-4 py-4 text-lg border border-gray-300 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800"
      />
    </div>

    <div id="search-results" class="space-y-4"></div>
  </div>

  <script define:vars={{ docs: sortedDocs.map(d => ({
    title: d.data.title,
    slug: d.slug,
    description: d.data.description,
    category: d.data.category,
  })) }}>
    // Client-side search initialization
    if (typeof window !== 'undefined') {
      const urlParams = new URLSearchParams(window.location.search);
      const queryParam = urlParams.get('q');

      const searchInput = document.getElementById('doc-search') as HTMLInputElement;
      const resultsContainer = document.getElementById('search-results');

      if (queryParam && searchInput) {
        searchInput.value = queryParam;
      }

      const performSearch = (query: string) => {
        if (!resultsContainer) return;

        if (query.length < 2) {
          resultsContainer.innerHTML = '';
          return;
        }

        const lowerQuery = query.toLowerCase();
        const results = docs.filter((doc: any) => {
          return (
            doc.title.toLowerCase().includes(lowerQuery) ||
            doc.description?.toLowerCase().includes(lowerQuery) ||
            doc.category?.toLowerCase().includes(lowerQuery)
          );
        });

        if (results.length === 0) {
          resultsContainer.innerHTML = '<p class="text-gray-500">No results found</p>';
          return;
        }

        resultsContainer.innerHTML = results.map((result: any) => `
          <a href="/docs/${result.slug}" class="block p-4 border border-gray-200 dark:border-gray-800 rounded-lg hover:border-blue-500 dark:hover:border-blue-500 transition-colors">
            <h3 class="text-lg font-semibold mb-1">${result.title}</h3>
            ${result.description ? `<p class="text-sm text-gray-600 dark:text-gray-400">${result.description}</p>` : ''}
          </a>
        `).join('');
      };

      if (searchInput && resultsContainer) {
        if (queryParam) {
          performSearch(queryParam);
        }

        searchInput.addEventListener('input', (e) => {
          performSearch((e.target as HTMLInputElement).value);
        });
      }
    }
  </script>
</DocLayout>
