---
import DocLayout from '../layouts/DocLayout.astro';
---

<DocLayout title="Workflow Execution Debugger">
  <div class="max-w-7xl mx-auto">
    <div class="mb-8">
      <h1 class="text-4xl font-bold mb-4">Workflow Execution Debugger</h1>
      <p class="text-gray-600 dark:text-gray-400">
        Monitor and debug workflow executions in real-time
      </p>
    </div>

    <!-- Execution Controls -->
    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 mb-6">
      <div class="flex justify-between items-center">
        <div>
          <h2 class="text-xl font-semibold mb-2">Execution Controls</h2>
          <p class="text-sm text-gray-600 dark:text-gray-400">Execution ID: exec-12345</p>
        </div>
        <div class="flex gap-2">
          <button
            onclick="startExecution()"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
          >
            ▶ Start
          </button>
          <button
            onclick="pauseExecution()"
            class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700"
          >
            ⏸ Pause
          </button>
          <button
            onclick="stopExecution()"
            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
          >
            ⏹ Stop
          </button>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Execution Timeline -->
      <div class="lg:col-span-2">
        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 mb-6">
          <h2 class="text-xl font-semibold mb-4">Execution Timeline</h2>
          <div id="execution-timeline" class="space-y-4">
            <!-- Sample execution steps -->
            <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg border-l-4 border-green-500">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <div class="font-semibold">Step 1: Initialize</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">design-agent</div>
                </div>
                <span class="px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded text-xs">Completed</span>
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-500 mt-2">
                Started: 10:00:00 | Duration: 2.3s
              </div>
            </div>

            <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg border-l-4 border-blue-500">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <div class="font-semibold">Step 2: Process Data</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">content-agent</div>
                </div>
                <span class="px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded text-xs">Running</span>
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-500 mt-2">
                Started: 10:00:02 | Duration: 5.1s (in progress)
              </div>
            </div>

            <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg border-l-4 border-gray-400">
              <div class="flex justify-between items-start mb-2">
                <div>
                  <div class="font-semibold">Step 3: Generate Output</div>
                  <div class="text-sm text-gray-600 dark:text-gray-400">seo-agent</div>
                </div>
                <span class="px-2 py-1 bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 rounded text-xs">Pending</span>
              </div>
              <div class="text-xs text-gray-500 dark:text-gray-500 mt-2">
                Waiting for dependencies...
              </div>
            </div>
          </div>
        </div>

        <!-- Execution Log -->
        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6">
          <h2 class="text-xl font-semibold mb-4">Execution Log</h2>
          <div id="execution-log" class="bg-gray-900 rounded-lg p-4 font-mono text-sm text-green-400 max-h-96 overflow-y-auto">
            <div>[10:00:00] Workflow execution started</div>
            <div>[10:00:00] Step 1: Initialize - Started</div>
            <div>[10:00:02] Step 1: Initialize - Completed (2.3s)</div>
            <div>[10:00:02] Step 2: Process Data - Started</div>
            <div>[10:00:07] Step 2: Process Data - In progress...</div>
          </div>
        </div>
      </div>

      <!-- Debug Panel -->
      <div>
        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6 mb-6">
          <h2 class="text-xl font-semibold mb-4">Debug Info</h2>
          <div class="space-y-4">
            <div>
              <div class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Status</div>
              <div class="text-lg font-semibold text-blue-600">Running</div>
            </div>
            <div>
              <div class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Progress</div>
              <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2 mb-2">
                <div class="bg-blue-600 h-2 rounded-full" style="width: 66%"></div>
              </div>
              <div class="text-sm text-gray-600 dark:text-gray-400">2 of 3 steps completed</div>
            </div>
            <div>
              <div class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Elapsed Time</div>
              <div class="text-lg font-semibold">7.4s</div>
            </div>
            <div>
              <div class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-1">Estimated Remaining</div>
              <div class="text-lg font-semibold">~3.2s</div>
            </div>
          </div>
        </div>

        <!-- Variables -->
        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-6">
          <h2 class="text-xl font-semibold mb-4">Context Variables</h2>
          <div class="space-y-2">
            <div class="p-2 bg-gray-50 dark:bg-gray-900 rounded">
              <div class="text-xs font-mono text-gray-600 dark:text-gray-400">step1.result</div>
              <div class="text-sm">{"status": "success", "data": {...}}</div>
            </div>
            <div class="p-2 bg-gray-50 dark:bg-gray-900 rounded">
              <div class="text-xs font-mono text-gray-600 dark:text-gray-400">workflow.input</div>
              <div class="text-sm">{"type": "page-design", ...}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3001/api';
    let currentExecutionId = null;

    async function startExecution() {
      const workflowId = prompt('Enter workflow ID:');
      if (!workflowId) return;

      try {
        const response = await fetch(`${API_BASE}/workflows/${workflowId}/execute`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({}),
        });

        if (response.ok) {
          const result = await response.json();
          currentExecutionId = result.executionId;
          alert(`Execution started! ID: ${currentExecutionId}`);
          startPolling();
        } else {
          const error = await response.json();
          alert(`Failed to start execution: ${error.error}`);
        }
      } catch (error) {
        console.error('Error starting execution:', error);
        alert('Failed to start execution. Check console for details.');
      }
    }

    function pauseExecution() {
      console.log('Pausing execution...');
      // Would call API to pause
    }

    function stopExecution() {
      console.log('Stopping execution...');
      // Would call API to stop
    }

    async function startPolling() {
      if (!currentExecutionId) return;

      const pollInterval = setInterval(async () => {
        try {
          const response = await fetch(`${API_BASE}/workflows/${currentExecutionId}/status?executionId=${currentExecutionId}`);
          if (response.ok) {
            const status = await response.json();
            updateExecutionStatus(status);

            if (status.status === 'completed' || status.status === 'failed') {
              clearInterval(pollInterval);
            }
          }
        } catch (error) {
          console.error('Error polling execution status:', error);
        }
      }, 1000);
    }

    function updateExecutionStatus(status) {
      // Update UI with execution status
      console.log('Execution status:', status);
      // Would update the timeline and log viewer
    }

    // Auto-start polling if execution ID is in URL
    const urlParams = new URLSearchParams(window.location.search);
    const executionId = urlParams.get('executionId');
    if (executionId) {
      currentExecutionId = executionId;
      startPolling();
    }
  </script>
</DocLayout>

