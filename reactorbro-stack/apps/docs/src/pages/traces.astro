---
import DocLayout from '../layouts/DocLayout.astro';

let traces: any[] = [];
let error: string | null = null;

try {
  // Try to fetch from API if available
  const API_BASE = 'http://localhost:3001/api';
  const response = await fetch(`${API_BASE}/traces`, {
    headers: { 'Accept': 'application/json' },
  });

  if (response.ok) {
    traces = await response.json();
  } else {
    // Fallback to direct import
    const { tracer } = await import('../../../../packages/observability/src/tracing/tracer.js');
    traces = tracer.getAllTraces(50);
  }
} catch (e: any) {
  // Fallback to direct import
  try {
    const { tracer } = await import('../../../../packages/observability/src/tracing/tracer.js');
    traces = tracer.getAllTraces(50);
  } catch (fallbackError: any) {
    error = e.message || 'Failed to load traces';
  }
}
---

<DocLayout title="Distributed Tracing">
  <div class="max-w-7xl mx-auto">
    <div class="mb-8">
      <h1 class="text-4xl font-bold mb-4">Distributed Tracing</h1>
      <p class="text-gray-600 dark:text-gray-400">
        Monitor request flows across services with distributed tracing
      </p>
    </div>

    {error ? (
      <div class="p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
        <p class="text-red-600 dark:text-red-400">Error loading traces: {error}</p>
      </div>
    ) : (
      <>
        <!-- Trace Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
          <div class="p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
            <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Total Traces</h3>
            <p class="text-3xl font-bold">{traces.length}</p>
          </div>
          <div class="p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
            <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Successful</h3>
            <p class="text-3xl font-bold text-green-600">
              {traces.filter(t => t.status === 'success').length}
            </p>
          </div>
          <div class="p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
            <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Failed</h3>
            <p class="text-3xl font-bold text-red-600">
              {traces.filter(t => t.status === 'error').length}
            </p>
          </div>
          <div class="p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
            <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">Pending</h3>
            <p class="text-3xl font-bold text-blue-600">
              {traces.filter(t => t.status === 'pending').length}
            </p>
          </div>
        </div>

        <!-- Trace List -->
        <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
            <h2 class="text-xl font-semibold">Recent Traces</h2>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
              <thead class="bg-gray-50 dark:bg-gray-900">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                    Trace ID
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                    Name
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                    Status
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                    Duration
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                    Spans
                  </th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                {traces.length === 0 ? (
                  <tr>
                    <td colspan="6" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                      No traces found
                    </td>
                  </tr>
                ) : (
                  traces.map((trace) => {
                    const statusIcon =
                      trace.status === 'success'
                        ? '✅'
                        : trace.status === 'error'
                          ? '❌'
                          : '⏳';
                    const statusColor =
                      trace.status === 'success'
                        ? 'text-green-600 dark:text-green-400'
                        : trace.status === 'error'
                          ? 'text-red-600 dark:text-red-400'
                          : 'text-blue-600 dark:text-blue-400';

                    const duration = trace.duration
                      ? `${trace.duration.toFixed(0)}ms`
                      : '—';

                    return (
                      <tr class="hover:bg-gray-50 dark:hover:bg-gray-900">
                        <td class="px-6 py-4 whitespace-nowrap">
                          <code class="text-sm font-mono">{trace.id.substring(0, 16)}...</code>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <div class="font-medium">{trace.name}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <span class={`${statusColor} font-medium`}>
                            {statusIcon} {trace.status}
                          </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                          {duration}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                          {trace.spans.length}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                          <a
                            href={`/traces/${trace.id}`}
                            class="text-blue-600 dark:text-blue-400 hover:underline"
                          >
                            View
                          </a>
                        </td>
                      </tr>
                    );
                  })
                )}
              </tbody>
            </table>
          </div>
        </div>
      </>
    )}
  </div>
</DocLayout>

